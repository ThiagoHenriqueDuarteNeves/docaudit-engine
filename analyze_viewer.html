<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DocAudit - Analyze Viewer</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f7f3ec;
      --panel: #ffffff;
      --ink: #1b1b1f;
      --muted: #5c5c66;
      --accent: #0f4c5c;
      --accent-soft: #e6f2f4;
      --border: #e2ddd6;
      --danger: #b33a3a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Source Serif 4", "Georgia", serif;
      font-size: 16px;
      background: radial-gradient(circle at 20% 20%, #ffffff 0%, #f7f3ec 45%, #efe7db 100%);
      color: var(--ink);
      overflow-x: hidden;
    }

    header {
      padding: 32px 24px 12px;
    }

    h1 {
      margin: 0 0 8px;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-size: 28px;
      letter-spacing: -0.02em;
    }

    p {
      margin: 0;
      color: var(--muted);
      line-height: 1.5;
    }

    main {
      display: grid;
      gap: 16px;
      padding: 16px 24px 40px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(30, 30, 40, 0.08);
      overflow-x: hidden;
    }

    label {
      display: block;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
      color: var(--muted);
    }

    input,
    textarea,
    button {
      width: 100%;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-size: 14px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }

    textarea {
      min-height: 160px;
      resize: vertical;
    }

    button {
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      border: none;
      font-weight: 600;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(15, 76, 92, 0.25);
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .row {
      display: grid;
      gap: 12px;
    }

    @media (min-width: 840px) {
      .row {
        grid-template-columns: 2fr 1fr;
      }
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: var(--accent-soft);
      color: var(--accent);
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
    }

    .section-title {
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-size: 16px;
      margin: 0 0 8px;
    }

    #summary,
    #meta {
      line-height: 1.55;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: #fffdf9;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .item h4 {
      margin: 0 0 6px;
      font-size: 14px;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
    }

    .item p {
      margin: 0 0 8px;
      font-size: 16px;
      line-height: 1.55;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .item .evidence {
      background: var(--accent-soft);
      border-radius: 10px;
      padding: 10px;
      font-size: 15px;
      color: #1d3840;
      line-height: 1.55;
      overflow-wrap: anywhere;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .muted {
      color: var(--muted);
    }

    .error {
      color: var(--danger);
      font-weight: 600;
    }

    .json-preview {
      font-family: "JetBrains Mono", "Courier New", monospace;
      font-size: 12px;
      background: #0f1f24;
      color: #e6f6ff;
      padding: 12px;
      border-radius: 0 0 12px 12px;
      overflow-x: hidden;
      overflow-y: auto;
      max-height: 480px;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
      margin: 0;
    }

    /* JSON Toolbar */
    .json-block {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #0f1f24;
      margin-top: 12px;
    }

    .json-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px;
      background: #1a2a30;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .json-header h4 {
      margin: 0;
      color: #aebbc2;
      font-size: 12px;
      font-family: "Space Grotesk", sans-serif;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .json-actions {
      display: flex;
      gap: 8px;
    }

    .sm-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #fff;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      width: auto;
      font-family: inherit;
      transition: background 0.2s;
    }

    .sm-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    /* JSON Tree Viewer */
    .jv-container {
      font-family: "JetBrains Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.5;
      padding: 12px;
      color: #e6f6ff;
    }

    .jv-node {
      margin-left: 18px;
    }

    .jv-key {
      color: #569cd6;
      margin-right: 4px;
    }

    .jv-string {
      color: #ce9178;
    }

    .jv-number {
      color: #b5cea8;
    }

    .jv-boolean {
      color: #569cd6;
    }

    .jv-null {
      color: #569cd6;
    }

    .jv-toggle {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 4px;
      cursor: pointer;
      vertical-align: middle;
      position: relative;
      top: -1px;
      user-select: none;
    }

    .jv-toggle::before {
      content: "‚ñ∂";
      font-size: 9px;
      color: #888;
      display: block;
      transition: transform 0.1s;
    }

    .jv-toggle.open::before {
      transform: rotate(90deg);
    }

    .jv-ellipsis {
      color: #666;
      font-size: 11px;
      cursor: pointer;
      user-select: none;
      background: #1a2a30;
      padding: 0 4px;
      border-radius: 2px;
    }
  </style>
</head>

<body>
  <header>
    <h1>DocAudit Engine ¬∑ Analyze Viewer</h1>
    <p>Envie um payload para <code>/api/analyze</code> e visualize o resultado em formato leg√≠vel.</p>
  </header>
  <main>
    <section class="panel grid">
      <div class="row">
        <div>
          <label for="endpoint">Endpoint</label>
          <input id="endpoint" type="text" value="http://localhost:8002/api/analyze" />
        </div>
        <div>
          <label for="analysisType">Analysis Type</label>
          <input id="analysisType" type="text" value="qa_requirements_audit" />
        </div>
      </div>
      <div class="grid">
        <div>
          <label for="docIds">Document IDs (1 por linha)</label>
          <textarea id="docIds">AuditDocEngine_Demo_SRS_QA_Requisitos.pdf</textarea>
        </div>
        <div>
          <label for="question">Pergunta (opcional)</label>
          <input id="question" type="text" placeholder="Ex: encontre ambiguidades no edital" />
        </div>
        <div>
          <label for="payloadJson">Payload JSON (opcional)</label>
          <textarea id="payloadJson"
            placeholder='Cole aqui o JSON completo para sobrescrever os campos acima.'></textarea>
          <p class="muted" style="margin-top:6px;">Se preenchido, o JSON abaixo substitui todos os campos.</p>
        </div>
        <div class="row">
          <div>
            <label for="maxItems">Max items por categoria</label>
            <input id="maxItems" type="number" value="5" min="1" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="runBtn" type="button">Executar an√°lise</button>
          </div>
        </div>
        <div id="status" class="muted"></div>
      </div>
    </section>

    <section class="panel">
      <div class="grid">
        <div class="row">
          <div>
            <h3 class="section-title">Resumo</h3>
            <div id="summary" class="muted">Sem dados ainda.</div>
          </div>
          <div>
            <h3 class="section-title">Meta</h3>
            <div id="meta" class="muted">Sem dados ainda.</div>
          </div>
        </div>

        <div>
          <h3 class="section-title" id="itemsTitle">Itens</h3>
          <div id="itemsContainer" class="grid"></div>
        </div>

        <!-- Raw JSON Block -->
        <div class="json-block">
          <div class="json-header">
            <h4>JSON Bruto</h4>
            <div class="json-actions">
              <button class="sm-btn" onclick="copyToClipboard('rawJsonData')">Copiar</button>
              <button class="sm-btn" onclick="toggleVisibility('rawJsonContainer')">Expandir/Ocultar</button>
            </div>
          </div>
          <textarea id="rawJsonData" style="display:none"></textarea>
          <div id="rawJsonContainer" class="json-preview"></div>
        </div>
      </div>
    </section>

    <!-- Debug Section -->
    <div id="debugSection"
      style="display:none; margin-top: 16px; border-top: 1px dashed var(--border); padding-top: 16px;">
      <h3 class="section-title" style="cursor:pointer" onclick="toggleDebug()">üêû Debug LLM (Clique para expandir)</h3>
      <div id="debugContent" style="display:none;">
        <div class="grid">
          <div class="item">
            <h4>Stats</h4>
            <pre id="debugStats" style="font-size:12px; margin:0">...</pre>
          </div>

          <!-- Request Block -->
          <div class="json-block">
            <div class="json-header">
              <h4>Request (Entrada)</h4>
              <div class="json-actions">
                <button class="sm-btn" onclick="copyToClipboard('debugRequestData')">Copiar</button>
                <button class="sm-btn" onclick="toggleVisibility('debugRequestContainer')">Expandir/Ocultar</button>
              </div>
            </div>
            <textarea id="debugRequestData" style="display:none"></textarea>
            <div id="debugRequestContainer" class="json-preview" style="background:#1a1016"></div>
          </div>

          <!-- Response Block -->
          <div class="json-block">
            <div class="json-header">
              <h4>Response Raw (Sa√≠da)</h4>
              <div class="json-actions">
                <button class="sm-btn" onclick="copyToClipboard('debugResponseData')">Copiar</button>
                <button class="sm-btn" onclick="toggleVisibility('debugResponseContainer')">Expandir/Ocultar</button>
              </div>
            </div>
            <textarea id="debugResponseData" style="display:none"></textarea>
            <div id="debugResponseContainer" class="json-preview" style="background:#0e1a14"></div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script>
    // --- UI Helpers ---
    function toggleDebug() {
      const el = document.getElementById("debugContent");
      el.style.display = el.style.display === "none" ? "block" : "none";
    }

    function toggleVisibility(id) {
      const el = document.getElementById(id);
      const isHidden = el.style.display === "none";
      el.style.display = isHidden ? "block" : "none";
    }

    function copyToClipboard(id) {
      const el = document.getElementById(id);
      if (!el) return;
      const text = el.value || el.textContent;
      navigator.clipboard.writeText(text).then(() => {
        alert("Conte√∫do copiado com sucesso!");
      }).catch(e => console.error(e));
    }

    // --- JSON Tree Renderer ---
    function renderJsonTree(data, container) {
      container.innerHTML = '';
      container.className = 'json-preview jv-container'; // Ensure styling
      container.appendChild(createNode(data));
    }

    function createNode(data) {
      if (data === null) return createLeaf('null', 'null');
      if (typeof data === 'boolean') return createLeaf(data, 'boolean');
      if (typeof data === 'number') return createLeaf(data, 'number');
      if (typeof data === 'string') return createLeaf(`"${data}"`, 'string');

      if (Array.isArray(data)) return createCollection(data, '[', ']');
      if (typeof data === 'object') return createCollection(data, '{', '}');
    }

    function createLeaf(val, type) {
      const span = document.createElement('span');
      span.className = `jv-${type}`;
      span.textContent = val;
      return span;
    }

    function createCollection(data, openChar, closeChar) {
      const frag = document.createDocumentFragment();
      const toggle = document.createElement('span');
      toggle.className = 'jv-toggle open';
      toggle.title = 'Expand/Collapse';

      const open = document.createTextNode(openChar);
      const close = document.createTextNode(closeChar);
      const ellipsis = document.createElement('span');
      ellipsis.className = 'jv-ellipsis';
      ellipsis.textContent = '...';
      ellipsis.style.display = 'none';

      const content = document.createElement('div');
      content.className = 'jv-node';

      const keys = Object.keys(data);
      keys.forEach((key, idx) => {
        const line = document.createElement('div');
        if (!Array.isArray(data)) {
          const k = document.createElement('span');
          k.className = 'jv-key';
          k.textContent = `"${key}":`;
          line.appendChild(k);
        }
        line.appendChild(createNode(data[key]));
        if (idx < keys.length - 1) line.appendChild(document.createTextNode(','));
        content.appendChild(line);
      });

      const handler = (e) => {
        e.stopPropagation();
        const isClosed = content.style.display === 'none';
        content.style.display = isClosed ? 'block' : 'none';
        ellipsis.style.display = isClosed ? 'none' : 'inline';
        toggle.className = isClosed ? 'jv-toggle open' : 'jv-toggle closed';
      };

      toggle.onclick = handler;
      ellipsis.onclick = handler;

      frag.appendChild(toggle);
      frag.appendChild(open);
      frag.appendChild(ellipsis);
      frag.appendChild(content);
      frag.appendChild(close);
      return frag;
    }

    // --- Main Logic ---
    const runBtn = document.getElementById("runBtn");
    const statusEl = document.getElementById("status");
    const summaryEl = document.getElementById("summary");
    const metaEl = document.getElementById("meta");
    const itemsContainer = document.getElementById("itemsContainer");
    const itemsTitle = document.getElementById("itemsTitle");

    // Formatters
    function formatMeta(meta) {
      if (!meta) return "Sem dados.";
      const docs = (meta.input_documents || []).map((d) => d.title || d.doc_id).join(", ");
      return `
      <div class="badge">${meta.analysis_type || "analysis"}</div>
      <p><strong>Documento:</strong> ${docs || "-"}</p>
      <p><strong>Modelo:</strong> ${(meta.model || {}).name || "-"}</p>
      <p><strong>Criado em:</strong> ${meta.created_at || "-"}</p>
      `;
    }

    function formatSummary(summary) {
      if (!summary) return "Sem dados.";
      const notes = (summary.coverage_notes || []).map((n) => `‚Ä¢ ${n}`).join("<br>");
      return `
      <p><strong>Resumo:</strong> ${summary.executive || "-"}</p>
      <p><strong>Confian√ßa:</strong> ${summary.confidence || "-"}</p>
      <p><strong>Notas:</strong><br>${notes || "-"}</p>
      `;
    }

    function renderGenericItems(items, title) {
      itemsContainer.innerHTML = "";
      itemsTitle.textContent = title;
      if (!items || items.length === 0) {
        itemsContainer.innerHTML = "<p class='muted'>Nenhum item encontrado.</p>";
        return;
      }
      items.forEach((item, index) => {
        const card = document.createElement("div");
        card.className = "item";
        let content = "";

        if (item.risk_type) {
          const impactColor = item.impact === 'alto' ? 'var(--danger)' : 'var(--accent)';
          content = `
          <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
            <h4 style="margin:0; color:${impactColor}">#${index + 1} ¬∑ Risco ${item.risk_type.toUpperCase()}</h4>
            <span class="badge" style="background:${impactColor}; color:white">${item.impact}</span>
          </div>
          <p><strong>Descri√ß√£o:</strong> ${item.description || "-"}</p>
          <p><strong>Justificativa:</strong> ${item.justification || "-"}</p>
          <p><strong>Mitiga√ß√£o:</strong> <em>${item.mitigation_question || "-"}</em></p>
          <div class="evidence"><strong>Evid√™ncia:</strong><br>${item.evidence || "-"}</div>
          `;
        } else if (item.question) {
          content = `
            <h4>#${index + 1} ¬∑ Ambiguidade</h4>
            <p><strong>Quest√£o:</strong> ${item.question || "-"}</p>
            <div class="evidence"><strong>Evid√™ncia:</strong><br>${item.evidence || "-"}</div>
          `;
        } else {
          content = `
            <h4>#${index + 1} ¬∑ Item</h4>
            <pre style="font-size:12px; overflow-x:auto">${JSON.stringify(item, null, 2)}</pre>
          `;
        }
        card.innerHTML = content;
        itemsContainer.appendChild(card);
      });
    }

    runBtn.addEventListener("click", async () => {
      const endpoint = document.getElementById("endpoint").value.trim();
      const payloadJson = document.getElementById("payloadJson").value.trim();
      const analysisType = document.getElementById("analysisType").value.trim();
      const docIds = document.getElementById("docIds").value
        .split("\n").map((line) => line.trim()).filter(Boolean);
      const question = document.getElementById("question").value.trim();
      const maxItems = Number(document.getElementById("maxItems").value) || 5;

      statusEl.textContent = "Executando...";
      statusEl.classList.remove("error");

      let payload;
      if (payloadJson) {
        try {
          payload = JSON.parse(payloadJson);
        } catch (err) {
          statusEl.textContent = "JSON invalido no payload.";
          statusEl.classList.add("error");
          return;
        }
      } else {
        payload = {
          document_ids: docIds,
          analysis_type: analysisType,
          max_items_per_category: maxItems
        };
        if (question) payload.question = question;
      }

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const json = await response.json();

        // Always render raw result
        document.getElementById("rawJsonData").value = JSON.stringify(json, null, 2);
        renderJsonTree(json, document.getElementById("rawJsonContainer"));

        if (!response.ok) {
          statusEl.textContent = `Erro ${response.status}`;
          statusEl.classList.add("error");
          return;
        }

        statusEl.textContent = "OK";
        summaryEl.innerHTML = formatSummary(json.summary);
        metaEl.innerHTML = formatMeta(json.meta);

        const items = json.items || {};
        if (items.risks && items.risks.length > 0) renderGenericItems(items.risks, "Riscos Detectados");
        else if (items.ambiguities && items.ambiguities.length > 0) renderGenericItems(items.ambiguities, "Ambiguidades Detectadas");
        else if (items.requirements && items.requirements.length > 0) renderGenericItems(items.requirements, "Requisitos Extra√≠dos");
        else {
          const key = Object.keys(items).find(k => Array.isArray(items[k]) && items[k].length > 0);
          renderGenericItems(items[key] || [], key ? key.replace(/_/g, " ").toUpperCase() : "Resultados");
        }

        // Debug Handling
        const debugSec = document.getElementById("debugSection");
        if (json.meta && json.meta.debug) {
          debugSec.style.display = "block";
          const d = json.meta.debug;
          document.getElementById("debugStats").textContent = JSON.stringify(d.context_stats, null, 2);

          // Request
          document.getElementById("debugRequestData").value = JSON.stringify(d.llm_request, null, 2);
          renderJsonTree(d.llm_request, document.getElementById("debugRequestContainer"));

          // Response Check
          let rRaw = d.llm_response_raw || "";
          let rParsed = rRaw;
          try { rParsed = JSON.parse(rRaw); } catch (e) { }

          document.getElementById("debugResponseData").value = typeof rParsed === 'string' ? rParsed : JSON.stringify(rParsed, null, 2);

          const respCont = document.getElementById("debugResponseContainer");
          if (typeof rParsed === 'object' && rParsed !== null) {
            renderJsonTree(rParsed, respCont);
          } else {
            respCont.innerHTML = `<pre style="margin:0">${rRaw}</pre>`;
          }
        } else {
          debugSec.style.display = "none";
        }

      } catch (err) {
        statusEl.textContent = "Falha ao chamar o endpoint.";
        statusEl.classList.add("error");
        console.error(err);
        document.getElementById("rawJsonContainer").textContent = String(err);
      }
    });
  </script>
</body>

</html>